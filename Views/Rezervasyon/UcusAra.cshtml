@model System.Collections.Generic.List<UcakBiletiRezervasyonSistemi.Models.Ucus>
@using System;
@using System.Linq;

@{
    ViewData["Title"] = "Arama Sonuçları";
    var fiyatServisi = ViewBag.FiyatServisi as UcakBiletiRezervasyonSistemi.Services.FiyatlandirmaServisi;
}

<h2><i class="fas fa-route"></i> Bulunan Uçuşlar</h2>
<hr />

@if (Model != null && Model.Count > 0 && fiyatServisi != null)
{
    <div class="row">
        @foreach (var ucus in Model)
        {
            // TARİH HESAPLAMA DÜZELTİLDİ
            var simdi = DateTime.Now;
            var ucusTarihi = ucus.KalkisTarihiSaati;
            
            // Sadece tarih kısmını karşılaştır (saat önemli değil)
            int kalanGun = (ucusTarihi.Date - simdi.Date).Days;
            
            // Negatif olmasın
            if (kalanGun < 0) kalanGun = 0;
            
            var dinamikFiyat = fiyatServisi.FiyatHesapla(ucus, 1);

            <div class="col-md-6 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-primary text-white">
                        <h4 class="mb-0"><i class="fas fa-plane"></i> @ucus.KalkisYeri → @ucus.VarisYeri</h4>
                    </div>
                    <div class="card-body">
                        <p><strong>Uçuş No:</strong> @ucus.UcusNo</p>
                        <p><strong>Kalkış Zamanı:</strong> @ucus.KalkisTarihiSaati.ToString("dd MMMM yyyy, HH:mm")</p>
                        
                        <p>
                            <strong>Kalan Süre:</strong> 
                            @if (kalanGun > 7)
                            {
                                <span class="badge bg-success">@kalanGun Gün Kaldı</span>
                            }
                            else if (kalanGun > 0)
                            {
                                <span class="badge bg-warning text-dark">@kalanGun Gün Kaldı</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">Bugün</span>
                            }
                        </p>
                        <p><strong>Kalan Koltuk:</strong> <span class="text-danger">@ucus.BosKoltukSayisi</span></p>
                    </div>
                    <div class="card-footer d-flex justify-content-between align-items-center">
                        <span class="h4 text-success mb-0">
                            @dinamikFiyat.ToString("C")
                        </span>
                        <a asp-controller="Rezervasyon" asp-action="Detay" asp-route-ucusNo="@ucus.UcusNo" class="btn btn-warning">Bilet Al</a>
                    </div>
                </div>
            </div>
        }
    </div>
}
else
{
    <div class="alert alert-warning">
        Belirtilen kriterlere uygun uçuş bulunamamıştır.
    </div>
    <a asp-action="Index" class="btn btn-primary">Yeni Arama Yap</a>
}